const run = require('./IntCodeComputer.js');
const permute = require('./Helpers.js')

const createAmplifier = (phase, program, name) => {
    const intCodeRunner = run(program);
    function amplify(signal, initialize){
        intCodeRunner.next();
        if(initialize){
            intCodeRunner.next(phase);
        }
        let output = intCodeRunner.next(signal);
        while(typeof(output.value) === 'undefined' && !output.done){
            output = intCodeRunner.next(signal)
        }
        return output;
    }
    return {amplify}
}

const program = "3,8,1001,8,10,8,105,1,0,0,21,38,55,80,97,118,199,280,361,442,99999,3,9,101,2,9,9,1002,9,5,9,1001,9,4,9,4,9,99,3,9,101,5,9,9,102,2,9,9,1001,9,5,9,4,9,99,3,9,1001,9,4,9,102,5,9,9,101,4,9,9,102,4,9,9,1001,9,4,9,4,9,99,3,9,1001,9,3,9,1002,9,2,9,101,3,9,9,4,9,99,3,9,101,5,9,9,1002,9,2,9,101,3,9,9,1002,9,5,9,4,9,99,3,9,1002,9,2,9,4,9,3,9,101,1,9,9,4,9,3,9,1002,9,2,9,4,9,3,9,101,1,9,9,4,9,3,9,1001,9,2,9,4,9,3,9,102,2,9,9,4,9,3,9,1002,9,2,9,4,9,3,9,1002,9,2,9,4,9,3,9,101,2,9,9,4,9,3,9,1002,9,2,9,4,9,99,3,9,102,2,9,9,4,9,3,9,1002,9,2,9,4,9,3,9,101,2,9,9,4,9,3,9,102,2,9,9,4,9,3,9,1002,9,2,9,4,9,3,9,101,1,9,9,4,9,3,9,101,2,9,9,4,9,3,9,102,2,9,9,4,9,3,9,1002,9,2,9,4,9,3,9,102,2,9,9,4,9,99,3,9,102,2,9,9,4,9,3,9,1002,9,2,9,4,9,3,9,102,2,9,9,4,9,3,9,102,2,9,9,4,9,3,9,1001,9,2,9,4,9,3,9,101,2,9,9,4,9,3,9,101,1,9,9,4,9,3,9,101,2,9,9,4,9,3,9,1001,9,2,9,4,9,3,9,102,2,9,9,4,9,99,3,9,1002,9,2,9,4,9,3,9,101,2,9,9,4,9,3,9,1001,9,2,9,4,9,3,9,102,2,9,9,4,9,3,9,102,2,9,9,4,9,3,9,1001,9,1,9,4,9,3,9,101,2,9,9,4,9,3,9,102,2,9,9,4,9,3,9,101,2,9,9,4,9,3,9,1001,9,1,9,4,9,99,3,9,102,2,9,9,4,9,3,9,101,1,9,9,4,9,3,9,1002,9,2,9,4,9,3,9,101,1,9,9,4,9,3,9,1001,9,2,9,4,9,3,9,1002,9,2,9,4,9,3,9,1002,9,2,9,4,9,3,9,1001,9,2,9,4,9,3,9,1001,9,1,9,4,9,3,9,102,2,9,9,4,9,99".split(",").map(n => parseInt(n));
const phaseSettings = permute([5,6,7,8,9], [], []);
let maxSignalToThruster = 0;
phaseSettings.forEach((setting) => {
    const amplifiers = setting.map((phase, i) => createAmplifier(phase, [...program], i));
    let amplifiedSignal = 0;
    let index = 0;
    let signalToThrusterFromAmpE = -1;
    while(true){
        const output = amplifiers[index].amplify(amplifiedSignal, signalToThrusterFromAmpE === -1);
        if(output.done) break;
        amplifiedSignal = output.value;
        if(index === 4){
            signalToThrusterFromAmpE = amplifiedSignal;
        }
        index = (index + 1) % 5;
    }
    maxSignalToThruster = signalToThrusterFromAmpE > maxSignalToThruster ? signalToThrusterFromAmpE : maxSignalToThruster;
});
console.log(maxSignalToThruster);